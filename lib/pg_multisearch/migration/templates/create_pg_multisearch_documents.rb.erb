class CreatePgMultisearchDocuments < ActiveRecord::Migration
  def up
    load_migration('create_pg_search_documents')

    ::CreatePgSearchDocuments.migrate(:down) if defined?(::CreatePgSearchDocuments)

    create_table :pg_search_documents

    execute <<-SQL.strip
<%= create_type_searchable %>
    SQL

    add_column :pg_search_documents, :tsv, :tsvector
    add_column :pg_search_documents, :header, :text
    add_column :pg_search_documents, :data, :jsonb
    add_column :pg_search_documents, :provenance, :datetime
    add_column :pg_search_documents, :searchable_type, :searchable, null: false, :limit => 15
    add_column :pg_search_documents, :searchable_id, :integer, null: false

    add_index :pg_search_documents, [:searchable_id, :searchable_type]
    add_index :pg_search_documents, :provenance
    add_index :pg_search_documents, :tsv, using: :gin

    <%= postgresql_version('<', 11000) %> && execute <<-SQL.strip
<%= create_function_jsonb_to_tsvector %>
    SQL

    execute <<-SQL.strip
<%= create_function_pg_search_words %>
    SQL

    execute <<-SQL.strip
<%= create_function_pg_search_document %>
    SQL

    execute <<-SQL.strip
<%= create_trigger_pg_search_tsvectorupdate %>
    SQL

    execute <<-SQL.strip
<%= create_index_pg_search_documents_header %>
    SQL
  end

  def down
    <%= postgresql_version('<', 11000) %> && execute <<-SQL.strip
<%= drop_function_jsonb_to_tsvector%>
    SQL

    execute <<-SQL.strip
<%= drop_function_pg_search_document %>
    SQL

    execute <<-SQL.strip
<%= drop_function_pg_search_words %>
    SQL

    execute <<-SQL.strip
<%= drop_trigger_pg_search_tsvectorupdate %>
    SQL

    execute <<-SQL.strip
<%= drop_type_searchable %>
    SQL

    remove_index :pg_search_documents, :tsv
    remove_index :pg_search_documents, :provenance
    remove_index :pg_search_documents, name: :pg_search_documents_header_idx

    drop_table :pg_search_documents

    # Restore original pg_search_documents table
    load_migration('create_pg_search_documents')

    ::CreatePgSearchDocuments.migrate(:up) if defined?(::CreatePgSearchDocuments)
  end
end
